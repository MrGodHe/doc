| 参考地址                                                     |
| ------------------------------------------------------------ |
| 官网入门地址：http://rocketmq.apache.org/docs/quick-start/   |
| 官网下载地址：http://rocketmq.apache.org/release_notes/release-notes-4.7.0/ |
| 英文文档：https://github.com/apache/rocketmq/tree/master/docs/en |
| 中文文档：https://github.com/apache/rocketmq/tree/master/docs/cn |

# RocketMq 安装

## 一、linux安装

1. 下载最新源版本

   ```
    > unzip rocketmq-all-4.7.0-source-release.zip             //解压
    > cd rocketmq-all-4.7.0/      
    > mvn -Prelease-all -DskipTests clean install -U          //mvn源码打包
    > cd distribution/target/rocketmq-4.7.0/rocketmq-4.7.0    //进入打包文件
   ```

2. 启动服务

   ```
   > nohup sh bin/mqnamesrv &                    //启动
   > tail -f ~/logs/rocketmqlogs/namesrv.log     //查看启动服务日志
    
    The Name Server boot success...             //成功日志示例     
   ```

3. 启动borker

   ```
   > nohup sh bin/mqbroker -n localhost:9876 &    //启动broker
   > tail -f ~/logs/rocketmqlogs/broker.log       //查看broker启动日志
    
    The broker[%s, 172.30.30.233:10911] boot success...   //成功日志示例
   ```

4. 发送和接收消息

   ```
    > export NAMESRV_ADDR=localhost:9876
    > sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
          
    SendResult [sendStatus=SEND_OK, msgId= ...]
         
    > sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer
    
    ConsumeMessageThread_%d Receive New Messages: [MessageExt...]
   ```

5. 关闭服务器

   ```
    > sh bin/mqshutdown broker
    
    The mqbroker(36695) is running...
    Send shutdown request to mqbroker(36695) OK
    
    > sh bin/mqshutdown namesrv
    
    The mqnamesrv(36664) is running...
    Send shutdown request to mqnamesrv(36664) OK 
   ```

   **注意**：roketMq 默认的jvm内存配置比较大，如仅测试机器可以适当调整， 需要修改找到runserver.sh 和 runbroker.sh
        （-server -Xms512m -Xmx512m -Xmn256m）



## 二、 windows安装

1. 下载最新的二进制版本。并将zip文件解压缩到本地磁盘中。如：D:\rocketmq

2. 配置系统环境变量：

   ```
   ROCKETMQ_HOME="D:\rocketmq"
   
   NAMESRV_ADDR="localhost:9876"
   ```

3. 启动服务        

   ```
   .\bin\mqnamesrv.cmd 
   ```

4. 启动broker    

   ```
   .\bin\mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true
   ```

5. 发送信息 

   ```
    .\bin\tool.cmd  org.apache.rocketmq.example.quickstart.Producer
   ```

6. 接收信息   

   ```
    .\bin\tool.cmd  org.apache.rocketmq.example.quickstart.Consumer
   ```

7. 关闭服务和broker， 关闭windows窗口就行



# 三、部署架构

![](../../image/rocketMq/rocketmq_architecture_3.png)

## 部署特点

- NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。

- Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。 注意：当前RocketMQ版本在部署架构上支持一Master多Slave，但只有BrokerId=1的从服务器才会参与消息的读负载。

- Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic 服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。

- Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，消费者在向Master拉取消息时，Master服务器会根据拉取偏移量与最大偏移量的距离（判断是否读老消息，产生读I/O），以及从服务器是否可读等因素建议下一次是从Master还是Slave拉取。

## 集群工作流程

1. 启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。
2. Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。
3. 收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。
4. Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息
5. Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。
